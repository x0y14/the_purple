on_war_started = {
	effect = {
		scope:attacker = {
			if = {
				limit = {
					any_vassal_or_below = { is_ai = no }
				}
				every_vassal_or_below = {
					limit = { is_ai = no }
					send_interface_toast = {
						type = msg_war_declared_by_liege
						title = msg_war_declared_by_liege
						desc = msg_war_declared_by_liege_desc
						left_icon = scope:attacker
						right_icon = scope:defender
					}
				}
			}
			create_character_memory = {
				type = offensive_war
				
				participants = {
					other_party = scope:defender
				}
			}
			ordered_memory = {
				limit = {
					has_memory_type = offensive_war
					any_memory_participant = { this = scope:defender }
				}
				order_by = memory_creation_date
				save_scope_as = offensive_memory
				set_war_memory_casus_belli_effect = yes
			}
			# If they're in an activity, let them decide whether or not to cancel 
			activity_on_war_declared_events_effect  = yes
			# Achievements.
			## Track whether the player has ever started a war — for various pacifist achievements.
			if = {
				limit = { is_ai = no }
				set_global_variable = {
					name = player_declared_war
					value = yes
				}
			}
			# BP2 Attacker has defender's hostage
			if = {	
				limit = {
					any_warden_hostage = { home_court ?= scope:defender }
					# Let defenders go first
					NOT = {
						scope:defender = {
							any_warden_hostage = { home_court ?= scope:attacker }
						}
					}
				}
				trigger_event = { id = bp2_hostage_system.0100 days = 3 }
			}
			# Enroute hostage invalidation
			if = {
				limit = {
					any_close_family_member = {
						is_travelling = yes
						var:hostage_travelling_to_warden ?= { is_at_war_with = scope:attacker }
					}
				}
				every_close_family_member = {
					limit = {
						is_travelling = yes
						var:hostage_travelling_to_warden ?= { is_at_war_with = scope:attacker }
					}
					save_scope_as = invalidated_hostage
					scope:attacker = {
						send_interface_toast = {
							title = hostage_invalidated_during_travel_title
							left_icon = scope:invalidated_hostage
							right_icon = scope:invalidated_hostage.var:hostage_travelling_to_warden
							show_as_tooltip = {
								scope:invalidated_hostage.current_travel_plan = { cancel_travel_plan = yes }
							}
						}
					}
					scope:invalidated_hostage.var:hostage_travelling_to_warden = {
						send_interface_toast = {
							title = hostage_invalidated_during_travel_title
							left_icon = scope:invalidated_hostage
							right_icon = scope:attacker
							scope:invalidated_hostage = {
								current_travel_plan = { cancel_travel_plan = yes }
								remove_variable = hostage_travelling_to_warden
							}
						}
					}
				}
			}
			# Struggle Catalysts
			## Log relative involvement for the war's end (since we may have title changes that mess us up otherwise).
			### Involved.
			if = {
				limit = {
					any_character_struggle = { involvement = involved }
				}
				random_character_struggle = {
					involvement = involved
					save_scope_as = struggle
				}
				scope:war = {
					set_variable = {
						name = struggle_involvement_attacker
						value = flag:involved
					}
					set_variable = {
						name = struggle_scope_attacker
						value = scope:struggle
					}
					set_variable = {
						name = struggle_attacker_tier
						value = scope:attacker.highest_held_title_tier
					}
				}
			}
			### Interloper.
			else_if = {
				limit = {
					any_character_struggle = { involvement = interloper }
				}
				random_character_struggle = {
					involvement = interloper
					save_scope_as = struggle
				}
				scope:war = {
					set_variable = {
						name = struggle_involvement_attacker
						value = flag:interloper
					}
					set_variable = {
						name = struggle_scope_attacker
						value = scope:struggle
					}
					set_variable = {
						name = struggle_attacker_tier
						value = scope:attacker.highest_held_title_tier
					}
				}
			}
			## Unfair wars.
			if = {
				limit = {
					has_trait = fp3_struggle_supporter
					highest_held_title_tier > scope:defender.highest_held_title_tier
					scope:war = {
						NOT = { has_variable = used_for_struggle_catalyst_on_war_started }
					}
					any_character_struggle = {
						involvement = involved
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_supporter_declare_unfair_war_within_the_region
							CHAR = scope:defender
						}
					}
				}
				every_character_struggle = {
					involvement = involved
					limit = {
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_supporter_declare_unfair_war_within_the_region
							CHAR = scope:defender
						}
					}
					activate_struggle_catalyst = {
						catalyst = catalyst_supporter_declare_unfair_war_within_the_region
						character = scope:attacker
					}
					scope:war = { set_variable = used_for_struggle_catalyst_on_war_started }
					log_debug_variable_for_persian_struggle_effect = { VAR = stabil_catalyst_supporter_declare_unfair_war_within_the_region }
				}
			}
			## Fair wars.
			else_if = {
				limit = {
					has_trait = fp3_struggle_supporter
					highest_held_title_tier <= scope:defender.highest_held_title_tier
					scope:war = {
						NOT = { has_variable = used_for_struggle_catalyst_on_war_started }
					}
					any_character_struggle = {
						involvement = involved
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_supporter_declare_fair_war_within_the_region
							CHAR = scope:defender
						}
					}
				}
				every_character_struggle = {
					involvement = involved
					limit = {
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_supporter_declare_fair_war_within_the_region
							CHAR = scope:defender
						}
					}
					activate_struggle_catalyst = {
						catalyst = catalyst_supporter_declare_fair_war_within_the_region
						character = scope:attacker
					}
					scope:war = { set_variable = used_for_struggle_catalyst_on_war_started }
					log_debug_variable_for_persian_struggle_effect = { VAR = stabil_catalyst_supporter_declare_fair_war_within_the_region }
				}
			}
			# During the Persian Struggle, a detractor wins any war in the region.
			## Unfair wars.
			else_if = {
				limit = {
					has_trait = fp3_struggle_detractor
					highest_held_title_tier > scope:defender.highest_held_title_tier
					scope:war = {
						NOT = { has_variable = used_for_struggle_catalyst_on_war_started }
					}
					any_character_struggle = {
						involvement = involved
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_detractor_declare_unfair_war_within_the_region
							CHAR = scope:defender
						}
					}
				}
				every_character_struggle = {
					involvement = involved
					limit = {
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_detractor_declare_unfair_war_within_the_region
							CHAR = scope:defender
						}
					}
					activate_struggle_catalyst = {
						catalyst = catalyst_detractor_declare_unfair_war_within_the_region
						character = scope:attacker
					}
					scope:war = { set_variable = used_for_struggle_catalyst_on_war_started }
					log_debug_variable_for_persian_struggle_effect = { VAR = unrest_catalyst_detractor_declare_unfair_war_within_the_region }
				}
			}
			## Fair wars.
			else_if = {
				limit = {
					has_trait = fp3_struggle_detractor
					highest_held_title_tier <= scope:defender.highest_held_title_tier
					scope:war = {
						NOT = { has_variable = used_for_struggle_catalyst_on_war_started }
					}
					any_character_struggle = {
						involvement = involved
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_detractor_declare_fair_war_within_the_region
							CHAR = scope:defender
						}
					}
				}
				every_character_struggle = {
					involvement = involved
					limit = {
						activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
							CATALYST = catalyst_detractor_declare_fair_war_within_the_region
							CHAR = scope:defender
						}
					}
					activate_struggle_catalyst = {
						catalyst = catalyst_detractor_declare_fair_war_within_the_region
						character = scope:attacker
					}
					scope:war = { set_variable = used_for_struggle_catalyst_on_war_started }
					log_debug_variable_for_persian_struggle_effect = { VAR = unrest_catalyst_detractor_declare_fair_war_within_the_region }
				}
			}
		}
		scope:defender = {
			if = {
				limit = {
					any_vassal_or_below = { is_ai = no }
				}
				every_vassal_or_below = {
					limit = { is_ai = no }
					send_interface_toast = {
						type = msg_war_declared_on_liege
						title = msg_war_declared_on_liege
						desc = msg_war_declared_on_liege_desc
						left_icon = scope:defender
						right_icon = scope:attacker
					}
				}
			}
			#life is just a joke tradition stress loss
			if = {
				limit = {
					scope:defender.culture = { has_cultural_parameter = war_stress_loss }
				}
				stress_impact = {
					base = medium_stress_loss
				}
			}
			create_character_memory = {
				type = defensive_war
				
				participants = {
					other_party = scope:attacker
				}
			}
			ordered_memory = {
				limit = {
					has_memory_type = defensive_war
					any_memory_participant = { this = scope:attacker }
				}
				order_by = memory_creation_date
				copy_war_memory_casus_belli_effect = { MEMORY = scope:offensive_memory }
			}
			# If they're in an activity, let them decide whether or not to cancel 
			activity_on_war_declared_events_effect = yes
			# BP2 Defender has attacker's hostage
			if = {
				limit = {
					any_warden_hostage = { home_court ?= scope:attacker }
				}
				trigger_event = { id = bp2_hostage_system.0110 days = 3 }
			}
			# Enroute hostage invalidation
			if = {
				limit = {
					any_close_family_member = {
						is_travelling = yes
						var:hostage_travelling_to_warden ?= { is_at_war_with = scope:defender }
					}
				}
				every_close_family_member = {
					limit = {
						is_travelling = yes
						var:hostage_travelling_to_warden ?= { is_at_war_with = scope:defender }
					}
					save_scope_as = invalidated_hostage
					scope:defender = {
						send_interface_toast = {
							title = hostage_invalidated_during_travel_title
							left_icon = scope:invalidated_hostage
							right_icon = scope:invalidated_hostage.var:hostage_travelling_to_warden
							show_as_tooltip = {
								scope:invalidated_hostage.current_travel_plan = { cancel_travel_plan = yes }
							}
						}
					}
					scope:invalidated_hostage.var:hostage_travelling_to_warden = {
						send_interface_toast = {
							title = hostage_invalidated_during_travel_title
							left_icon = scope:invalidated_hostage
							right_icon = scope:defender
							scope:invalidated_hostage = {
								current_travel_plan = { cancel_travel_plan = yes }
								remove_variable = hostage_travelling_to_warden
							}
						}
					}
				}
			}
			# BP2 Hostage War Aid request event
			if = { # Exclude the following CBs
				limit = {
					scope:war = {
						NOR = {
							using_cb = peasant_war
							using_cb = populist_war
							using_cb = undirected_great_holy_war
							using_cb = directed_great_holy_war
						}
					}
					scope:attacker = {
						is_ai = yes
					}
					scope:defender = {
						has_bp2_dlc_trigger = yes
					}
				}
				if = {
					limit = {
						is_hostage_warden = yes
						# Check if the defender has any hostages whose home court is not the attacker and is not allied to the attacker
						any_warden_hostage = {
							opinion = {
								target = scope:defender
								value > 0
							}
							age > 9
							is_imprisoned = no
							is_incapable = no
							exists = home_court
							home_court = {
								age > 4
								is_ai = yes
								is_imprisoned = no
							}
							NOR = {
								home_court = scope:attacker
								home_court = {
									is_allied_to = scope:attacker
									is_allied_to = scope:defender
									is_at_war_with = scope:defender
								}
							}
						}
					}
					random_warden_hostage = {
						limit = {
							opinion = {
								target = scope:defender
								value > 0
							}
							age > 9
							is_imprisoned = no
							is_incapable = no
							exists = home_court
							home_court = {
								age > 4
								is_ai = yes
								is_imprisoned = no
							}
							NOR = {
								home_court ?= scope:attacker
								home_court ?= {
									is_allied_to = scope:attacker
									is_allied_to = scope:defender
									is_at_war_with = scope:defender
								}
							}
						}
						save_scope_as = hostage
						scope:hostage.home_court = {
							save_scope_as = home_court
						}
					}
					trigger_event = { id = bp2_yearly.6200 days = { 5 10 } }
				}
			}
			# Struggle Catalysts
			## Log relative involvement for the war's end (since we may have title changes that mess us up otherwise).
			### Involved.
			if = {
				limit = {
					any_character_struggle = { involvement = involved }
				}
				random_character_struggle = {
					involvement = involved
					save_scope_as = struggle
				}
				scope:war = {
					set_variable = {
						name = struggle_involvement_defender
						value = flag:involved
					}
					set_variable = {
						name = struggle_scope_defender
						value = scope:struggle
					}
					set_variable = {
						name = struggle_defender_tier
						value = scope:defender.highest_held_title_tier
					}
				}
			}
			### Interloper.
			else_if = {
				limit = {
					any_character_struggle = { involvement = interloper }
				}
				random_character_struggle = {
					involvement = interloper
					save_scope_as = struggle
				}
				scope:war = {
					set_variable = {
						name = struggle_involvement_defender
						value = flag:interloper
					}
					set_variable = {
						name = struggle_scope_defender
						value = scope:struggle
					}
					set_variable = {
						name = struggle_defender_tier
						value = scope:defender.highest_held_title_tier
					}
				}
			}

			# # -- the purple --
			# if = {
			# 	limit = {
			# 		any_character_struggle = { involvement = involved }
			# 	}
			# 	# activate_struggle_catalyst = {
			# 	# 	catalyst = catalyst_basileus_was_declared_war_tp
			# 	# 	character = scope:attacker
			# 	# }
			# 	every_character_struggle = {
			# 		involvement = involved
			# 		# limit = {
			# 		# 	activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
			# 		# 		CATALYST = catalyst_supporter_declare_unfair_war_within_the_region
			# 		# 		CHAR = scope:defender
			# 		# 	}
			# 		# }
			# 		activate_struggle_catalyst = {
			# 			catalyst = catalyst_basileus_was_declared_war_tp
			# 			character = scope:attacker
			# 		}
			# }
			# # ----------------
		}
		# # -- the purple --
		# if = {
		# 	limit = {
		# 		scope:defender = {
		# 			# AND = {
		# 			# 	any_character_struggle = {
		# 			# 		is_struggle_type = byzantine_struggle
		# 			# 		involvement = involved
		# 			# 	}
		# 			# 	has_title = title:e_byzantium
		# 			# }
		# 			has_title = title:e_byzantium
		# 		}
		# 	}
		# 	activate_struggle_catalyst_secondary_character_involvement_involved_trigger = {
		# 		catalyst = catalyst_basileus_was_declared_war_tp
		# 		character = scope:attacker
		# 	}
		# }
		# # ----------------
	}
}
